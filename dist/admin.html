<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>基础数据导入</title>
    <script type="text/javascript" src="jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="xlsx.full.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
        }

        table, tr, td {
            border: 1px red solid;
        }
    </style>

</head>
<body>

<input type="file" onchange="importf(this)"/>
<div id="demo"></div>
<button id="xlsx">提交</button>

<script>
    var wb;//读取完成的数据
    var rABS = false; //是否将文件读取为二进制字符串

    function importf(obj) {//导入
        if (!obj.files) {
            return;
        }
        var f = obj.files[0];
        window.f = f;
        var reader = new FileReader();
        reader.onload = function (e) {
            var data = e.target.result;
            if (rABS) {
                wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                    type: 'base64'
                });
            } else {
                wb = XLSX.read(data, {
                    type: 'binary'
                });
            }
            //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
            //wb.Sheets[Sheet名]获取第一个Sheet的数据
            document.getElementById("demo").innerHTML = JSON.stringify(XLSX.utils.sheet_to_html(wb.Sheets[wb.SheetNames[0]]));
        };
        if (rABS) {
            reader.readAsArrayBuffer(f);
        } else {
            reader.readAsBinaryString(f);
        }
    }

    function fixdata(data) { //文件流转BinaryString
        var o = "",
            l = 0,
            w = 10240;
        for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
        return o;
    }

</script>

<script>
    $(function () {
        $("#xlsx").on("click", function () {

            var formData = new FormData();
            formData.append("file", window.f);

            $.ajax({
                url: "/api/xlsx",
                type: "POST",
                data: formData,
                // dataType: "json",
                processData: false,
                contentType: false,
                success: function (data) {
                    console.log(data);
                    alert(data.msg);
                }
            });
        });
    })
</script>

</body>
</html>
