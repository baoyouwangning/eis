<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>运费查询</title>

    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-table.min.css">
    <link rel="stylesheet" src="bootstrap-editable.css"/>

    <script type="text/javascript" src="jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="bootstrap-table.min.js"></script>
    <script type="text/javascript" src="bootstrap-table-zh-CN.min.js"></script>
    <script type="text/javascript" src="bootstrap.min.js"></script>
    <script type="text/javascript" src="bootstrap-editable.min.js"></script>
    <script type="text/javascript" src="bootstrap-table-editable.js"></script>
    <script type="text/javascript" src="decimal.js"></script>
</head>
<body>

<table id="eis-table"></table>

<script type="text/javascript">
    $(function () {
        function computedCols(data) {
            var titleList = data[0];
            var dataCols = [
                {
                    "field": "0",
                    "title": titleList[0]
                }, {
                    "field": "9",
                    "title": titleList[9],
                    editable: {
                        type: 'text',
                        title: titleList[9],
                        validate: function (v) {
                            if (isNaN(v)) {
                                return '请输入数字～'
                            }

                            return false;
                        }
                    }
                }, {
                    "field": "10",
                    "title": titleList[10],
                    formatter: function (value, row, index) {
                        return new Decimal(value);
                    }
                }, {
                    "field": "15",
                    "title": titleList[15],
                    formatter: function (value, row, index) {
                        return new Decimal(value);
                    }
                }
            ];

            return dataCols;
        }

        function transformOriginData(data) {
            var dataCols = computedCols(data);

            var dataSource = data.slice(1);

            initTable(dataCols, dataSource);
        }

        function initTable(dataCols, dataSource) {
            // $.fn.editable.defaults.mode = 'inline';

            $("#eis-table").bootstrapTable({
                toolbar: "#toolbar",
                idField: "0",
                pagination: true,
                showRefresh: true,
                search: true,
                clickToSelect: true,
                // url: '/api/data',
                queryParams: function (param) {
                    return {};
                },
                data: dataSource,
                columns: dataCols,
                onEditableSave: function (field, row, oldValue, $el) {
                    // debugger;
                    console.log(field, row, oldValue, $el);

                    function ridx(char) {
                        return char.charCodeAt(0) - 'A'.charCodeAt(0);
                    }

                    function add() {
                        var res = 0;
                        for (var i = 0; i < arguments.length; i++) {
                            res = Decimal.add(res, arguments[i]);
                        }
                        return res;
                    }

                    function mul(args) {
                        var res = 1;
                        for (var i = 0; i < arguments.length; i++) {
                            res = Decimal.mul(res, arguments[i]);
                        }
                        return res;
                    }

                    /* 开始计算
                     *
                     * */
                    // 每票基础费用 H2=B2+C2+D2
                    var H2 = add(row[ridx("B")], row[ridx("C")], row[ridx("D")]);

                    // 续重 I2=E2+F2+G2+0.3
                    var I2 = add(row[ridx("E")], row[ridx("F")], row[ridx("G")], 0.3);

                    // 汽车成本价格 K2=(I2*J2)+H2
                    var K2 = add(mul(I2, row[ridx("J")]), H2);

                    // 计算首重 N2=H2+L2
                    var N2 = add(H2, row[ridx("L")]);

                    // 计算续重 O2=E2+F2+M2+0.3
                    var O2 = add(row[ridx("E")], row[ridx("F")], row[ridx("M")], 0.3);

                    // 空运成本价格 P2=N2+O2*J2
                    var P2 = add(N2, mul(O2, row[ridx("J")]));

                    // 更新汽车成本显示
                    $($el).parent().next().text(K2);

                    // 更新空运成本显示
                    $($el).parent().next().next().text(P2);
                }
            });
        }

        $.ajax({
            url: "/api/data",
            type: "get",
            success: function (data) {
                console.log(data);

                // 浮点数修正
                for(var i = 1; i < data.length; i++) {
                    for (var j = 0; j < data[i].length; j++) {
                        if (data[i][j] && !isNaN(data[i][j]) && -1 !== data[i][j].toString().indexOf('.')) {
                            data[i][j] = data[i][j].toFixed(2);
                        }
                    }
                }

                // 数据结构转换
                transformOriginData(data);
            }
        });
    });
</script>

</body>
</html>
