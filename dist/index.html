<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>包裹运输成本查询</title>

    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-table.min.css">
    <link rel="stylesheet" href="bootstrap-editable.css"/>

    <script type="text/javascript" src="jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="bootstrap-table.min.js"></script>
    <script type="text/javascript" src="bootstrap-table-zh-CN.min.js"></script>
    <script type="text/javascript" src="bootstrap.min.js"></script>
    <script type="text/javascript" src="bootstrap-editable.min.js"></script>
    <script type="text/javascript" src="bootstrap-table-editable.js"></script>
    <script type="text/javascript" src="decimal.js"></script>
</head>
<body>

<h3 class="bg-info text-center">包裹运输成本查询</h3>

<table id="eis-table"></table>

<script type="text/javascript">
    $(function () {

        // 生成文件列表
        function genList(list, container) {
            var wrap = $('<div class="list-wrap"><h3 class="text-center">请选择表格</h3></div>');
            var ul = $('<ol>');

            list.forEach(function (item) {
                var li = $('<li style="margin:10px auto;">');
                var a = $('<a class="btn btn-primary">');

                a.text(item.name);
                a.attr('href', item.url);

                li.append(a);
                ul.append(li);
            });

            wrap.append(ul);
            container.append(wrap);
        }

        // 定义一些公用方法
        function ridx(char) {
            return char.charCodeAt(0) - 'A'.charCodeAt(0);
        }

        function add() {
            var res = 0;
            for (var i = 0; i < arguments.length; i++) {
                res = Decimal.add(res, arguments[i]);
            }
            return res;
        }

        function mul(args) {
            var res = 1;
            for (var i = 0; i < arguments.length; i++) {
                res = Decimal.mul(res, arguments[i]);
            }
            return res;
        }

        // 快运计算 展示计算页
        function showComputePage(data) {

            function computedCols(data) {
                var titleList = data[0];
                var dataCols = [
                    {
                        "field": "0",
                        "title": titleList[0]
                    }, {
                        "field": "1",
                        "title": titleList[1]
                    }, {
                        "field": "15",
                        "title": titleList[15],
                        editable: {
                            type: 'text',
                            title: titleList[15],
                            validate: function (v) {
                                if (isNaN(v)) {
                                    return '请输入数字～'
                                }

                                return false;
                            }
                        },
                        formatter: function (value, row, index) {
                            return new Decimal(value || 0);
                        }
                    }, {
                        "field": "16",
                        "title": titleList[16],
                        formatter: function (value, row, index) {
                            return new Decimal(value || 0);
                        }
                    }, {
                        "field": "17",
                        "title": titleList[17],
                        formatter: function (value, row, index) {
                            return new Decimal(value || 0);
                        }
                    }
                ];

                return dataCols;
            }
            function initTable(dataCols, dataSource) {
                /* $.fn.editable.defaults.mode = 'inline'; */

                $("#eis-table").bootstrapTable({
                    toolbar: "#toolbar",
                    idField: "0",
                    pagination: true,
                    showRefresh: true,
                    search: true,
                    clickToSelect: true,
                    queryParams: function (param) {
                        return {};
                    },
                    data: dataSource,
                    columns: dataCols,
                    onEditableSave: function (field, row, oldValue, $el) {
                        console.log(field, row, oldValue, $el);

                        /* 开始计算 */
                        /* 找到区间价格 */
                        var nextValue = row[ridx("P")];
                        var fixedPrice = 0;
                        var economicPrice = 0;
                        if (nextValue >= 0 && nextValue <= 150) {
                            fixedPrice = row[ridx("D")];
                            economicPrice = row[ridx("J")];
                        } else if (nextValue >= 151 && nextValue <= 300) {
                            fixedPrice = row[ridx("E")];
                            economicPrice = row[ridx("K")];
                        } else if (nextValue >= 301 && nextValue <= 500) {
                            fixedPrice = row[ridx("F")];
                            economicPrice = row[ridx("L")];
                        } else if (nextValue >= 501 && nextValue <= 1000) {
                            fixedPrice = row[ridx("G")];
                            economicPrice = row[ridx("M")];
                        } else if (nextValue >= 1001) {
                            fixedPrice = row[ridx("H")];
                            economicPrice = row[ridx("N")];
                        }

                        /* 定日达成本价格： P3*定日达单价+P3*O3 （如果P3的数值在D2的范围内 就用P3*D3+P3*O3）*/
                        var Q3 = mul(nextValue, add(fixedPrice, row[ridx("O")]));
                        /* 经济快运成本价格： P3*经济快运单价+P3*O3 （如果P3的数值在J2的范围内 就用P3*J3+P3*O3）*/
                        var R3 = mul(nextValue, add(economicPrice, row[ridx("O")]));

                        /* 最低费与实际费比较 */
                        Q3 = Q3 > row[ridx('C')] ? Q3 : row[ridx('C')];
                        R3 = R3 > row[ridx('I')] ? R3 : row[ridx('I')];

                        /* 更新定日达成本价格显示 */
                        $($el).parent().next().text(Q3);

                        /* 更新经济快运成本价格显示 */
                        $($el).parent().next().next().text(R3);
                    }
                });
            }

            var dataCols = computedCols(data);
            var dataSource = data.slice(2);

            initTable(dataCols, dataSource);
        }

        // 请求文件列表
        if (-1 !== location.search.indexOf('d=')) {

            $.ajax({
                url: "/api/data",
                data: {
                    d: location.search.replace(/.*(\?|&)d=([^&]*)/,"$2")
                },
                success: function (tableFull) {
                    console.log(tableFull);

                    // Sheet1: 数据修正
                    var data = tableFull[0].data;
                    for(var i = 1; i < data.length; i++) {
                        for (var j = 0; j < data[i].length; j++) {
                            if (data[i][j] && !isNaN(data[i][j]) && -1 !== data[i][j].toString().indexOf('.')) {
                                data[i][j] = Number(data[i][j]).toFixed(2);
                            }
                        }
                    }

                    // Sheet2: 拼接function string
                    var funString = '';
                    var codeData = tableFull[1].data;
                    for(var i = 0; i < codeData.length; i++) {
                        for(var j = 0; j < codeData[i].length; j++) {
                            funString += codeData[i][j];
                        }
                    }

                    // 执行Sheet2代码
                    // eval(funString);
                    showComputePage(data);
                }
            });
        } else {
            $.ajax({
                url: "/api/list",
                success: function (data) {
                    console.log(data);

                    genList(data.data, $(document.body));
                }
            });
        }

    });
</script>

</body>
</html>
